<i18n>
{
  "en": {
    "glossary": "Glossary of Terms",
    "search": "Look for",
    "fprev": "Find Prev",
    "fnext": "Find Next",
    "all": "All",
    "Z": "Alien Species",
    "A": "Characters - Aliens",
    "D": "Characters - Droids",
    "H": "Characters - Human",
    "E": "Events",
    "F": "Flora and Fauna",
    "G": "Groups and Organizations",
    "C": "Locations - Cities",
    "L": "Locations - Misc",
    "P": "Locations - Planets",
    "R": "Locations - Space",
    "S": "Locations - Systems",
    "K": "Technology",
    "T": "Terminology",
    "N": "Vehicles (named)",
    "V": "Vehicles (types)",
    "W": "Weapons",
    "eprev": "Previous Entry",
    "enext": "Next Entry",
    "topic": "Go To Topic",
    "references": "References",
    "description": "Description",
    "AC": "Ambush at Corellia",
    "AS": "Assault at Selonia",
    "BTS": "Before the Storm",
    "BW": "X-Wing: The Bacta War",
    "CCG": "Star Wars Customizable Card Game",
    "COF": "Champions of the Force",
    "COJ": "Children of the Jedi",
    "CPL": "The Courtship of Princess Leia",
    "CS": "The Crystal Star",
    "CSSB": "Han Solo and the Corporate Sector Sourcebook",
    "CSW": "Classic Star Swars (Dark Horse Comics)",
    "DA": "Dark Apprentice",
    "DE": "Dark Empire",
    "DE2": "Dark Empire II",
    "DESB": "Dark Empire Sourcebook",
    "DF": "Dark Forces (Video Game)",
    "DFR": "Dark Force Rising",
    "DFRSB": "Dark Force Rising Source Book",
    "DLS": "Tales of the Jedi: Dark Lords of the Sith",
    "DS": "Star Wars Droids Special (Dark Horse Comics)",
    "DSTC": "Death Star Technical Companion",
    "EE": "Empire's End",
    "EGC": "The Essential Guide to Characters",
    "EGPM": "The Essential Guide to Planets and Moons",
    "EGV": "The Essential Guide to Vehicles and Vessels",
    "ESB": "The Empire Strikes Back",
    "ESBN": "The Empire Strikes Back (novel)",
    "ESBR": "The Empire Strikes Back (radio)",
    "ESBSB": "The Empire Strikes Back Sketchbook",
    "ETV": "Star Wars: Ewoks (animated TV series)",
    "FNU": "Tales of the Jedi: Freedon Nadd Uprising",
    "FP": "Farlander Papers",
    "GDV": "The Glove of Darth Vader",
    "GG1": "Galaxy Guide 1: A New Hope",
    "GG2": "Galaxy Guide 2: Yavin and Bespin",
    "GG3": "Galaxy Guide 3: The Empire Strikes Back",
    "GG4": "Galaxy Guide 4: Alien Races",
    "GG5": "Galaxy Guide 5: Return of the Jedi",
    "GG7": "Galaxy Guide 7: Mos Eisley",
    "GG11": "Galaxy Guide 11: Criminal Organizations",
    "GG12": "Galaxy Guide 12: Aliens — Enemies and Allies",
    "GSWU": "A Guide to the Star Wars Universe",
    "HE": "Heir to the Empire",
    "HESB": "Heir to the Empire Sourcebook",
    "HSE": "Han Solo at Stars' End",
    "HLL": "Han Solo Lost Legacy",
    "HSR": "Han Solo's Revenge",
    "ISB": "Imperial Sourcebook",
    "ISWU": "The Illustrated Star Wars Universe",
    "JS": "Jedi Search",
    "LC": "The Last Command",
    "MTS": "Movie Trilogy Sourcebook",
    "MTSB": "Movie Trilogy Sourcebook",
    "NR": "The New Rebellion",
    "PDS": "Prophets of the Dark Side",
    "POT": "Planet of Twilight",
    "RJ": "Return of the Jedi",
    "RJN": "Return of the Jedi (novel)",
    "ROC": "River of Chaos (Dark Horse Comics)",
    "SAC": "Showdown at Centerpoint",
    "SFS": "Strike Force Shantipole",
    "SOL": "Shield of Lies",
    "SOTE": "Shadows of the Empire",
    "SOTESB": "Shadows of the Empire Sourcebook",
    "SW": "Star Wars: A New Hope",
    "SWAJ": "Star Wars Adventure Journal",
    "SWN": "Star Wars: A New Hope (novel)",
    "SWCG": "The Essential Guide to Characters",
    "SWR": "Star Wars: Rebellion",
    "SWSB": "The Star Wars Sourcebook",
    "SWVG": "The Essential Guide to Vehicles and Vessels",
    "SWWT": "The Essential Guide to Weapons and Technology",
    "TAB": "The Truce at Bakura",
    "TBH": "Tales of the Bounty Hunters",
    "TJP": "Tales from Jabba's Palace",
    "TMEC": "Tales from Mos Eisley Cantina",
    "TOBH": "Tales of the Bounty Hunters (Again)",
    "TOJ": "Tales of the Jedi (Dark Horse Comic)",
    "TOJFSE": "Tales of the Jedi: The Fall of the Sith Empire",
    "TOJGA": "Tales of the Jedi: The Golden Age of the Sith",
    "TOJDL": "Tales of the Jedi: Dark Lords of the Sith",
    "TOJSW": "Tales of the Jedi: The Sith War",
    "TSW": "Tales of the Jedi: The Sith War",
    "TT": "Tyrant's Test",
    "XW": "X-Wing series",
    "XWSA": "X-Wing: Starfighters of Adumar",
    "YJK": "Young Jedi Knights",
    "etc.": "Luke is everywhere"
  },
  "fr": {
    "glossary": "Glossaire de termes",
    "search": "Rechercher",
    "fprev": "Précédent",
    "fnext": "Suivant",
    "all": "Tous",
    "Z": "Extraterrestres",
    "A": "Personnages - Extraterrestres",
    "D": "Personnages - Droïdes",
    "H": "Personnages - Humains",
    "E": "Evénements",
    "F": "Faune et Flore",
    "G": "Groupes and Organisations",
    "C": "Lieux - Villes",
    "L": "Lieux - Divers",
    "P": "Lieux - Planètes",
    "R": "Lieux - Espace",
    "S": "Lieux - Systèmes",
    "K": "Technologie",
    "T": "Terminologie",
    "N": "Véhicules (noms)",
    "V": "Véhicules (types)",
    "W": "Armes",
    "eprev": "Entrée précédente",
    "enext": "Entrée suivante",
    "topic": "Aller au sujet",
    "references": "Références",
    "description": "Description"
  }
}
</i18n>

<template>
  <div class="glossary">
    <audio v-play src="@/components/Scenes/Lost/lost.snm.mp3" ></audio>
    <span class="glossarytitle">{{ $t('glossary') }}</span>
    <button class="fprev" @click="search(-1)">{{ $t('fprev') }} &#9664;</button>
    <input ref="searchstr" type="text" style="text-align:center;" :placeholder="$t('search')">
    <button class="fnext" @click="search(1)">&#9654; {{ $t('fnext') }}</button>

    <select v-model="selectedCategory" class="categories" size="5">
      <option value="all">{{ $t('all') }}</option>
      <option v-for="cat in orderedCategories" :value="cat.letter">{{ $t(cat.letter) }}</option>
    </select>

    <select ref="selectEntry" v-model="selectedEntry" class="entries" size="20">
      <option v-for="entry in filteredEntries(selectedCategory)" :value="entry" v-html="entry.name"></option>
    </select>

    <button class="prevent" @click="prevEntry">&#9664; {{ $t('eprev') }}</button>

    <button class="nextent" @click="nextEntry">&#9654; {{ $t('enext') }}</button>

    <span class="name" v-html="selectedEntry.name"></span>
    <div class="picture" :style="{ backgroundImage: 'url(static/Glossary/STILLS/' + selectedEntry.picture +')' }" v-if="!!this.selectedEntry.picture"></div>
    <p class="description" ref="description" v-if="!showReferences" v-html="selectedEntry.description"></p>
    <p class="description" ref="references"  v-if="showReferences">
      <ul>
        <li v-for="reference in selectedEntry.references">{{ $t(reference) }}</li>
      </ul>
    </p>
    <router-link class="topic" :to="selectedEntry.topic" v-if="!!this.selectedEntry.topic">{{ $t('topic') }}</router-link>
    <button class="references" v-if="!!this.selectedEntry.references" @click="showReferences = !showReferences">{{ showReferences ? $t('description') : $t('references') }}</button>
  </div>
</template>

<script>
import databaseEN from '@/components/Glossary/glossary.en.json'
import databaseFR from '@/components/Glossary/glossary.fr.json'
export default {
  name: 'Glossary',
  props: ['locale'],
  data () {
    return {
      categories: [
        {letter: 'Z'},
        {letter: 'A'},
        {letter: 'D'},
        {letter: 'H'},
        {letter: 'E'},
        {letter: 'F'},
        {letter: 'G'},
        {letter: 'C'},
        {letter: 'L'},
        {letter: 'P'},
        {letter: 'R'},
        {letter: 'S'},
        {letter: 'K'},
        {letter: 'T'},
        {letter: 'N'},
        {letter: 'V'},
        {letter: 'W'}
      ],
      database: {
        'en': databaseEN,
        'fr': databaseFR
      },
      selectedCategory: 'all',
      entries: {},
      selectedEntry: {},
      searchstr: '',
      showReferences: false
    }
  },
  methods: {
    filteredEntries (category) {
      let entries
      if (category === 'all') {
        entries = this.database[this.$root.locale]
      } else {
        entries = this.database[this.$root.locale].filter(item => item.category === category)
      }

      if (Object.keys(this.selectedEntry).length === 0) {
        this.selectedEntry = entries[0]
      }

      let actualEntry = entries.filter(item => item.originalName === this.selectedEntry.originalName)
      if (actualEntry[0]) {
        this.selectedEntry = actualEntry[0]
      } else {
        this.selectedEntry = {}
      }

      this.entries = entries
      return entries
    },
    prevEntry () {
      let selectEntry = this.$refs['selectEntry']
      if (selectEntry.selectedIndex) {
        this.selectedEntry = this.entries[selectEntry.selectedIndex - 1]
      }
    },
    nextEntry () {
      let selectEntry = this.$refs['selectEntry']
      if (selectEntry.selectedIndex !== (selectEntry.childElementCount - 1)) {
        this.selectedEntry = this.entries[selectEntry.selectedIndex + 1]
      }
    },
    search (direction) {
      let str = this.$refs['searchstr'].value
      if (str === '') {
        return false
      }
      this.searchstr = str

      let selectEntry = this.$refs['selectEntry']
      let i = selectEntry.selectedIndex
      if (this.$refs['description'].innerHTML.includes('<mark>')) {
        if (i + direction >= 0 && i + direction <= this.entries.length - 1) {
          i += direction
        }
      }

      while (i + direction >= 0 && i + direction <= this.entries.length - 1 && !this.entries[i].description.includes(str)) {
        i += direction
      }

      this.selectedEntry = this.entries[i]

      var escapedstr = (function escapeRegExp (str) {
        return str.replace(/([.*+?^=!:${}()|[\]/\\])/g, '\\$1')
      })(str)

      let that = this
      setTimeout(function () {
        that.$refs['description'].innerHTML = that.$refs['description'].innerHTML.replace(new RegExp(escapedstr, 'g'), '<mark>' + str + '</mark>')
      }, 0)
    }
  },
  computed: {
    orderedCategories () {
      let that = this
      let sorted = this.categories.sort(function (a, b) {
        if (that.$t(a.letter) < that.$t(b.letter)) return -1
        if (that.$t(a.letter) > that.$t(b.letter)) return 1
        return 0
      })
      return sorted
    }
  },
  watch: {
    selectedEntry: function () {
      this.showReferences = false
    }
  }
}
</script>


<style scoped>
.glossary{
  background-image: url("GLOSBACK.jpg");
}

span{
  font-family: 'Mech';
  font-size: 30px;
  color: white;
  letter-spacing: 1px;
  position: absolute;
}

.glossarytitle{
  top: 5px; left: 10px;
}

select{
  position: absolute; left: 5px;
  background-color: black;
  color: #CCCCCC;
  border: 4px solid black;
  width: 173px;
  overflow-y: scroll;
  overflow-x: hidden;
  text-overflow: ellipsis;
  font-size: 11px;
  padding: 2px;
}
.categories {top: 40px;}
.entries {top: 132px; }

button{
  background-color: transparent;
  border: none;
  position: absolute;
  color: white;
  font-size: 12px;
}

.fprev{
  top: 12px; left: 260px;
  background-color: black;
  border-radius: 15px 0 0 0;
  width: 75px; height: 19px;
  white-space: nowrap;
}
.fnext{
  top: 12px; left: 530px;
  background-color: black;
  border-radius: 0 15px 0 0;
  width: 75px; height: 19px;
  white-space: nowrap;
}

.prevent{
  top: 57px;
  left: 415px;
  width: 225px;
  height: 20px;
  padding: 0;
  background-color: rgba(96,24,24,0.5);
}
.nextent{
  top: 421px;
  left: 415px;
  width: 225px;
  height: 20px;
  padding: 0;
  background-color: rgba(96,24,24,0.5);
}

input{
  position: absolute;
  top: 12px;
  left: 335px;
  width: 195px; height: 19px;
  font-size: 10px;
}

.name{
  top: 85px; left: 207px;
  display: block;
  width: 433px; height: 38px;
  padding-left: 10px;
  background-color: rgba(0, 0, 0, 0.5);
  line-height: 38px;
}

.picture{
  position: absolute;
  top: 140px; left: 215px;
  width: 120px; height: 120px;
  border-radius: 10%;
  box-shadow: black 3px 3px 10px;
  background-size: cover;
}

.description{
  color: white;
  margin: 0;
  font-size: 12px;
  position: absolute;
  top: 130px;
  left: 347px;
  width: 280px;
  height: 280px;
  line-height: normal;
  word-spacing: 2px;
  overflow-y: auto;
  text-align: justify;
  padding-right: 10px;
}

.topic{
  position: absolute;
  top: 280px;
  left: 230px;
  width: 95px;
  height: 20px;
  text-align: center;
  border-radius: 10px;
  color: #303030;
  background-color: white;
  box-shadow: inset #808080 -2px -2px 4px;
  font-size: 14px;
}

.topic:hover, .references:hover{
  background-color: #E0E0E0;
}

.topic:active, .references:hover{
  box-shadow: inset #808080 2px 2px 4px;
}

.references{
  position: absolute;
  top: 330px;
  left: 230px;
  width: 95px;
  height: 20px;
  text-align: center;
  border-radius: 10px;
  color: #303030;
  background-color: white;
  box-shadow: inset #808080 -2px -2px 4px;
  font-size: 14px;
}

</style>
